# File: nginx/nginx.conf (Phiên bản hoàn thiện có SSL)
events {}

http {
    # Định nghĩa tất cả các upstream services
    upstream backend_app1 { server backend:5001; }
    upstream backend_app2 { server backend:5004; }
    upstream backend_app3 { server backend:5000; }
    upstream backend_app4 { server backend:5005; }
    upstream backend_app5 { server backend:5007; }
    upstream backend_chatbot { server backend:5009; }
    upstream frontend { server frontend:80; } # <<< ĐÃ THÊM

    # Server block này bắt tất cả request đến cổng 80 (HTTP)
    # và chuyển hướng vĩnh viễn (301) sang HTTPS.
    server {
        listen 80;
        # Lắng nghe cho cả tên miền gốc và www
        server_name hdfitnessyoga.club www.hdfitnessyoga.club; # <<< ĐÃ SỬA
        return 301 https://$host$request_uri;
    }

    # Server block chính, xử lý các request HTTPS trên cổng 443
    server {
        listen 443 ssl;
        server_name hdfitnessyoga.club www.hdfitnessyoga.club;

        # Cấu hình SSL
        ssl_certificate /etc/nginx/ssl/fullchain.crt;
        ssl_certificate_key /etc/nginx/ssl/private.key; # <<< ĐÃ SỬA LỖI CHÍNH TẢ

        # Các cài đặt SSL bảo mật (khuyến nghị)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers off;

        # --- CÁC LOCATION ĐÃ ĐƯỢC CHUẨN HÓA ---
        # Thêm các proxy_set_header cần thiết vào tất cả các location
        location /api/app1/ {
            proxy_pass http://backend_app1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/app2/ {
            proxy_pass http://backend_app2/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/app3/ {
            proxy_pass http://backend_app3/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/app4/ {
            proxy_pass http://backend_app4/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/app5/ {
            proxy_pass http://backend_app5/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location /api/app6/ {
            proxy_pass http://backend_chatbot/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}